<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Home</title>
    <!-- Bootstrap Import -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/jquery.easing.1.3.min.js"></script>
    <script type="text/javascript" src="js/transition.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
    <script src="cordova.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>

    <link rel="stylesheet" href="css/index.css">

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Prompt" rel="stylesheet">

    <style>
        #title {
            color: #666666;
            letter-spacing: 2px;
        }

        .no-pd {
            padding-right: 0px;
            padding-left: 0px;
            font-size: 120%;
        }

        hr {
            margin-top: 0;
        }
    </style>

    <script>
        var arr_data;
        var datetime;
        var sum = 0;
        $(document).ready(function () {
            var d = new Date($.now());            
            $('#date').text(d.getDate() + "/" + (d.getMonth()+1) + "/" + d.getFullYear()); 
            datetime = d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds(); 

            $.ajax({
                type: "GET",
                url:"https://omise-webpack.000webhostapp.com/www/php/get_ware.php",                            
                success: function(data){
                    var obj = jQuery.parseJSON(data);                                                      
                    $.each(obj, function(i, field){                                        
                        $('#ul-ware').append("<li id='li-ware-"+i+"' onclick='setware("+i+");' style='padding-bottom: 10px;'>"+field.ware_name+"</li>" +
                        "<span id='id-ware-"+i+"' hidden>"+field.ware_id+"</span>");
                    });                                        
                }               
            });

            var retrievedObject = localStorage.getItem('arr_prod');
            arr_data = JSON.parse(retrievedObject);          
            for(var i = 0 ; i < arr_data.length ; i ++){                              
                var sum_prod = arr_data[i].cost*arr_data[i].amt;
                sum += parseInt(sum_prod);
                $('#show-import').append("<div id='prod-"+i+"' class='row'>\
                <span id='id-prod-"+i+"' hidden>"+arr_data[i].prod_id+"</span>\
                <div class='col-1 text-center no-pd'>\
                    <i id='i-del-"+i+"' class='fa fa-trash-alt i-del' onclick='remove("+i+");' hidden></i>\
                    <i id='i-edit-"+i+"' class='fa fa-edit i-edit' onclick='edit_prod("+i+");' hidden></i>\
                    <i id='i-check-"+i+"' class='fa fa-check i-check' onclick='update_prod("+i+");' hidden style='color: green;'></i>\
                </div>\
                <div id='i-collapse-"+i+"' class='col-6 text-center no-pd' onclick='collapse("+i+");'>"+arr_data[i].name+"</div>\
                <div class='col-3 text-center'>\
                    <input id='price-"+i+"' type='number' class='w3-input' value='"+arr_data[i].cost+"' style='border: none; font-size: 120%;' readonly>\
                </div>\
                <span style='font-size: 120%;'>x</span>\
                <div class='col-1 text-center no-pd'>\
                    <input id='amount-"+i+"' type='number' class='w3-input' value='"+arr_data[i].amt+"' style='border: none;' readonly>\
                </div>\
            </div>\
            <!-- Collapse-1 -->\
            <div id='collapse-"+i+"' class='container collapse' style='margin-top: 5%;'>\
                <div class='row'>\
                    <div class='col-12 text-center'>\
                        <img id='img' src='"+arr_data[i].img+"' alt='' style='width: 96%; height: 96%; border-radius: 3px;'>\
                    </div>\
                </div>\
                <div class='row' style='margin-bottom: 4%; margin-top: 4%;'>\
                    <div class='col-2'></div>\
                    <div class='col-4 text-center no-pd'>รหัส : </div>\
                    <div class='col-4 text-center no-pd'>"+arr_data[i].qr+"</div>\
                    <div class='col-2'></div>\
                </div>\
                <div class='row' style='margin-bottom: 4%;'>\
                    <div class='col-2'></div>\
                    <div class='col-4 text-center no-pd'>รวม : </div>\
                    <div class='col-4 text-center no-pd'>"+sum_prod+"</div>\
                    <div class='col-2'></div>\
                </div>\
            </div>\
            <hr id='hr-"+i+"' style='margin-top: 5%;'>");                    
            }            
            $("#net").text(sum.toLocaleString()); // 50000 -> 50,000;
        });

        function save(){
            json_string = JSON.stringify(arr_data); 
            var dataString =  "JSON=" + json_string + "&ware_id=" + ware_id + "&date=" + datetime + "&sum=" + sum;                        

            $.ajax({
                type: "POST",
                url:"https://omise-webpack.000webhostapp.com/www/php/stock_in.php",           
                data: dataString,               
                success: function(data){                             
                    alert(data);
                    if(data == "success"){
                        localStorage.arr_prod = "";                                                   
                        goto = "import.html";
                        transition_page_back(goto);            
                    }
                }               
            });
        }

        function remove(num){
            var cost = $('#price-'+num).val();   
            var amt = $('#amount-'+num).val();
            var net = $("#net").html();           
            var sum2 = parseFloat(net.replace(/,/g, ''))-(cost*amt);
            sum = sum2;          
            $("#net").text(sum2.toLocaleString());   
            $('#prod-'+num).remove();   
            $('#collapse-'+num).remove();   
            $('#hr-'+num).remove();   
            //arr_data[num].qr = 0;
            arrange(num);
        }

        function arrange(arg){
            arr_data.splice(arg,1);       
            for(var i = arg+1; i <= arr_data.length; i++){
                $("#prod-"+i).prop('id', 'prod-'+(i-1));
                $("#id-prod-"+i).prop('id', 'id-prod-'+(i-1));
                $("#i-del-"+i).attr('onclick', "remove("+(i-1)+")");          
                $("#i-edit-"+i).attr('onclick', "edit_prod("+(i-1)+")");        
                $("#i-check-"+i).attr('onclick', "update_prod("+(i-1)+")");       
                $("#i-del-"+i).prop('id', 'i-del-'+(i-1));
                $("#i-edit-"+i).prop('id', 'i-edit-'+(i-1));
                $("#i-check-"+i).prop('id', 'i-check-'+(i-1));
                $("#price-"+i).prop('id', 'price-'+(i-1));
                $("#amount-"+i).prop('id', 'amount-'+(i-1));
                $("#i-collapse-"+i).attr('onclick', "collapse("+(i-1)+")");     
                $("#i-collapse-"+i).prop('id', 'i-collapse-'+(i-1));
                $("#collapse-"+i).prop('id', 'collapse-'+(i-1));
                $("#hr-"+i).prop('id', 'hr-'+(i-1));              
            } 
            localStorage.setItem('arr_prod', JSON.stringify(arr_data));          
        }

        function disactive(arg) {
            nav_menu = ['home', 'add', 'edit', 'del'];
            for (i = 0; i < 4; i++) {
                if (nav_menu[i] != arg) {
                    if ($("#i-" + nav_menu[i]).hasClass('active')) $("#i-" + nav_menu[i]).removeClass('active');
                }
            }
        }

        function menu(arg) {
            // Animate
            disactive(arg);
            $("#i-" + arg).fadeOut(100).fadeIn(100, function () {
                $("#i-" + arg).addClass('active');
            });

            if (arg == "add") {
                /*goto = "sale.html";
                transition_page_back(goto);*/
            } else if (arg == "edit") {
                // show edit all
                $(".i-edit").attr('hidden', false);
                $(".i-del").attr('hidden', true);
            } else if (arg == "del") {
                // show trash all 
                $(".i-del").attr('hidden', false);
                $(".i-edit").attr('hidden', true);
            }
        }      

        function check_edit(arg) {
            val = true;
            // 4 is max prod
            for (i = 0; i < 4; i++) {
                if ($("#i-check-" + i).is(":visible") && i != arg) {
                    val = false;
                    break;
                }
            }

            return val;
        }
       
        var sum_old;
        function edit_prod(arg) {
            //check if some i-check is show then
            if (check_edit(arg)) {
                $("#i-edit-" + arg).attr('hidden', true);
                $("#i-check-" + arg).attr('hidden', false);
                $("#amount-" + arg).removeAttr('style');
                //$("#price-" + arg).removeAttr('style');
                $("#amount-" + arg).attr("readonly", false);
                //$("#price-" + arg).attr("readonly", false);
                var amt = $("#amount-" + arg).val();
                var cost = $('#price-'+arg).val();
                sum_old = amt*cost;  
            }
        }

        function update_prod(arg) {
            $("#i-edit-" + arg).attr('hidden', false);
            $("#i-check-" + arg).attr('hidden', true);
            $("#amount-" + arg).css('border', 'none');
            //$("#price-" + arg).css('border', 'none');
            $("#amount-" + arg).attr("readonly", true);
            /*$("#price-" + arg).attr("readonly", true);
            $.alert({
                title: 'สำเร็จ!',
                content: 'บันทึกการเปลี่ยนแปลง',
            });*/
            var cost = $('#price-'+arg).val();   
            var amt = $('#amount-'+arg).val();
            arr_data[arg].amt = amt; 
            localStorage.setItem('arr_prod', JSON.stringify(arr_data));     
            sum = (sum-sum_old)+(amt*cost);
            $("#net").text(sum.toLocaleString());  
        }

        function collapse(arg) {
            // 4 is num of prod
            for (i = 0; i < 4; i++) {
                if (i != arg && $("#collapse-" + i).is(":visible")) {
                    $("#collapse-" + i).slideToggle('collapse');
                }
            }

            $("#collapse-" + arg).slideToggle('collapse', function () {
                $('html, body').animate({
                    scrollTop: $("#collapse-" + arg).height()
                }, 900);
            });
        }

        var ware_id;
        function setware(arg) {
            ware = $("#li-ware-" + arg).text();
            $("#ware").val(ware);
            ware_id = $("#id-ware-" + arg).text();
        }
    </script>
</head>

<body>
    <!-- Nav menu top -->
    <div class="row fixed-top navs">
        <div class="col-1 text-center" onclick="transition_page_back('import.html')">
            <i id="i-back" class="fas fa-angle-left"></i>
        </div>
        <div class="col-10 text-center">
            <h5 id="h5-title">ตรวจสอบ</h5>
        </div>
        <div class="col-1">
        </div>
    </div>
    <br>

    <!-- End big container -->
    <div id="big-ctn" class="container justify-content-center" style="margin-top: 15%; margin-bottom: 30%;">

        <div id="show-import" class="container">
            <div class="row" style="margin-bottom: 5%;">
                <div class="col-3 text-center no-pd">วันที่ : </div>
                <div id="date" class="col-2 text-center no-pd"></div>
                <div class="col-2 text-center no-pd"></div>
                <div class="col-4 text-center no-pd">เลขที่ใบเสร็จ : </div>
                <div class="col-1 text-center no-pd">auto</div>
            </div>
            <div class="row" style="margin-bottom: 10%;">
                <div class="col-3 text-center no-pd">ผู้ใช้ : </div>
                <div id="user" class="col-3 text-center no-pd">test</div>
                <div class="col-1 text-center no-pd"></div>
                <div class="col-5 text-center no-pd">
                    <input id="ware" type="text" class="w3-input" data-toggle="dropdown" placeholder="โกดัง" readonly>
                    <ul id="ul-ware" class="dropdown-menu text-center" aria-labelledby="role" style="width: 80%;">                                        
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-1 text-center no-pd"></div>
                <div class="col-6 text-center no-pd">
                    <h5 id="title">สินค้า</h5>
                </div>
                <div class="col-3 text-center">
                    <h5 id="title">ทุน</h5>
                </div>
            </div>
            <hr>

            <!-- Show -->  
        </div>
    </div>
    <!-- End big container -->

    <div class="row fixed-bottom navs" style="margin-bottom: 15%; border: none !important; background-color: #fdfdfd !important;">
        <div class="col-6 text-center">
            <button id="btn-check" class="svbtn" onclick="save();">บันทึก</button>
        </div>
        <div class="col-6 text-right">
            <h5 class="title" style="font-size: 150%; text-decoration: underline;">รวม : <span id="net" style="color: red;"></span></h5>
        </div>
    </div>
    <!-- Nav menu bottom -->
    <div class="row fixed-bottom navs">
        <div class="col-3 text-center" onclick="menu('home')">
            <i id="i-home" class="fas fa-home menu"></i>
        </div>
        <div class="col-3 text-center" onclick="menu('add')">
            <i id="i-add" class="fas fa-plus menu"></i>
        </div>
        <div class="col-3 text-center" onclick="menu('edit')">
            <i id="i-edit" class="fas fa-edit menu"></i>
        </div>
        <div class="col-3 text-center" onclick="menu('del')">
            <i id="i-del" class="fa fa-trash-alt menu"></i>
        </div>
    </div>
    <!-- End Nav menu bottom -->
</body>

</html>