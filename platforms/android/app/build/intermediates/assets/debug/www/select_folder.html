<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Home</title>
  <!-- Bootstrap Import -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="js/jquery-ui.min.js"></script>
  <script type="text/javascript" src="js/jquery.easing.1.3.min.js"></script>
  <script type="text/javascript" src="js/transition.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
  <script src="cordova.js"></script>

  <link rel="stylesheet" href="css/index.css">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css?family=Prompt" rel="stylesheet">

  <style>
    #title {
      color: #666666;
      letter-spacing: 2px;
    }

    .six{
      color: #666;
    }

    .checked{
      color: #66b266;
    }
  </style>

  <script>
    var parent;
    var index;
    var last_node = 0;
    $(document).ready(function() {
      url = new URL(window.location.href);
      folder = url.searchParams.get("folder");  
      from = url.searchParams.get("from");
   
      if(folder != null){
        $("#h5-title").text(folder);
        parent = folder;
      } else{
        $("#h5-title").text("หมวดหมู่");
        parent = "car";
      }

      $.ajax({
        type: "POST",
        url:"https://omise-webpack.000webhostapp.com/www/php/get_folder.php",                         
        data: {'parent' : parent},  
        success: function(data){            
            if(data == "last node"){
              // เลือกกับเข้าไป
              if(parent == "car"){
                $("#add-ctn").prop('hidden', false);
              }else{
                $("#add-ctn").prop('hidden', false);
                if(from == "add"){                 
                  $("#row-select").prop('hidden', false);
                }else if(from == "import" || from == "tran_in" || from == "export" || from == "sale"){                 
                  $("#row-select").prop('hidden', true);
                }                
              }
            }else{           
              var obj = jQuery.parseJSON(data); 
              //console.log(obj); 
              if(obj[obj.length-1] == "last node"){
                //last node have product 
                $("#main-ctn").prop('hidden', false);     
                  if(from == "add"){
                    $("#add-ctn").prop('hidden', false);
                    $("#add-ctn").prop('style', "margin-top: 20%;");
                    $("#row-add").prop('hidden', true);
                    $("#row-input-add").prop('hidden', true);
                    $("#row-select").prop('hidden', false);       
                  }else if(from == "import" || from == "tran_in" || from == "export" || from == "sale" || from == "stock"){                    
                    $("#add-ctn").prop('hidden', true);
                    $("#show-box").prop('hidden',false);                                       
                  } 
                  $.each(obj, function(i, field){
                    if(obj.length-1 > i){
                      text_html = "<div id='row-title-"+i+"' class='row'>" +
                        "<span id='span-"+i+"' hidden>" + obj[i].title + "</span>" +
                        "<div class='col-2 text-center'><i id='box-"+i+"' class='far fa-check-square six seven' onclick='check("+i+")' hidden></i></div>" +
                        "<div id='getin-"+i+"' class='col-8 text-center' onclick='getIn(\"" + obj[i].title + "\")'>" +
                        "<h5 id='title-"+i+"'>" + obj[i][2] + "</h5>" +
                        "</div>" +
                        "<div class='col-2'>" +
                        "<i class='fa fa-trash-alt i-trash' onclick='remove("+i+")' hidden></i>" +
                        "<i class='fa fa-edit i-edit' onclick='edit("+i+")' hidden></i>" +
                        "</div>" +
                        "</div >"+
                        "<div id='row-edit-"+i+"' class='row' hidden>" +
                        "<div class='col-2 text-right' onclick='rename("+i+");'>" +
                        "<i class='fa fa-check'></i>" +
                        "</div >" +
                        "<div class='col-8 text-center'>" +
                        "<input id='input-"+i+"' type='text' class='w3-input' value='"+ obj[i][2] +"'>" +
                        "</div>" +
                        "<div class='col-2' onclick='close_row_edit("+i+");'>" +
                        "<i class='fa fa-times'></i>" +
                        "</div>" +
                        "</div>" + "<hr id='hr-"+i+"'>";
                      $("#append-ctn").append(text_html);
                      index = i;
                      }                                                 
                    });
                    last_node = 1;                                     
              }else{
                $("#main-ctn").prop('hidden', false);      
                $("#add-ctn").prop('hidden', true);
                $.each(obj, function(i, field){
                if(obj.length-1 > i){
                  text_html = "<div id='row-title-"+i+"' class='row'>" +
                    "<span id='span-"+i+"' hidden>" + obj[i].title + "</span>" +
                    "<div class='col-2'></div>" +
                    "<div id='getin-"+i+"' class='col-8 text-center' onclick='getIn(\"" + obj[i].title + "\")'>" +
                    "<h5 id='title-"+i+"'>" + obj[i].title + "</h5>" +
                    "</div>" +
                    "<div class='col-2'>" +
                    "<i class='fa fa-trash-alt i-trash' onclick='remove("+i+")' hidden></i>" +
                    "<i class='fa fa-edit i-edit' onclick='edit("+i+")' hidden></i>" +
                    "</div>" +
                    "</div >"+
                    "<div id='row-edit-"+i+"' class='row' hidden>" +
                    "<div class='col-2 text-right' onclick='rename("+i+");'>" +
                    "<i class='fa fa-check'></i>" +
                    "</div >" +
                    "<div class='col-8 text-center'>" +
                    "<input id='input-"+i+"' type='text' class='w3-input' value='"+ obj[i].title +"'>" +
                    "</div>" +
                    "<div class='col-2' onclick='close_row_edit("+i+");'>" +
                    "<i class='fa fa-times'></i>" +
                    "</div>" +
                    "</div>" + "<hr id='hr-"+i+"'>";
                  $("#append-ctn").append(text_html);
                  index = i;
                  }                                                 
                });               
              }                               
            }                          
        }               
      });
        // index = i;
    });   
    function show_box(){    
      if ($(".seven").is(":visible")) {
          $(".seven").attr('hidden', true);        
        } else {
          $(".seven").attr('hidden', false);         
      }
    }

    arr_prod = [];
    function check(arg){
      //console.log('row ' + arg + ' checked');
      $("#box-"+arg).removeClass('six'); 
      $("#box-"+arg).removeClass('far'); 
      $("#box-"+arg).addClass('checked'); 
      $("#box-"+arg).addClass('fa');
      $("#box-"+arg).attr('onclick', 'uncheck('+arg+')'); 

      $("#show-box-go").prop('hidden',false);
      $("#show-box").prop('hidden',true);
      var ch = false;
      for(var i = 0 ; i < arr_prod.length ; i++){
          if(arr_prod[i].arg == arg){
            arr_prod[i].prod_id = $('#span-'+arg).text();
            ch = true;
            break;
          }
      }
      if(!ch){          
          item = {};   
          item ["arg"] = arg;        
          item ["prod_id"] = $('#span-'+arg).text();         
          arr_prod.push(item);          
      }     
    }

    function uncheck(arg){
      //console.log('row ' + arg + ' unchecked');
      $("#box-"+arg).removeClass('checked'); 
      $("#box-"+arg).removeClass('fa'); 
      $("#box-"+arg).addClass('six'); 
      $("#box-"+arg).addClass('far'); 
      $("#box-"+arg).attr('onclick', 'check('+arg+')');

      for(var i = 0 ; i < arr_prod.length ; i++){
        if(arr_prod[i].arg == arg){
            arr_prod[i].prod_id = 0;
            break;
        }
      } 

      var ch = 0;
      for(var i=0 ; i <= index;i++){
        if($('#box-'+i).hasClass('six')){
          ch++;
        }
      }
      if(ch-1 == index){
        $("#show-box-go").prop('hidden',true);
        $("#show-box").prop('hidden',false);
      }
    }

    function nextselect(){
      json = [];
      for(var i = 0 ; i < arr_prod.length ; i++){
        if(arr_prod[i].prod_id != 0){
            item = {}
            item["prod_id"] = arr_prod[i].prod_id;           
            json.push(item);               
        }
      }       
      url = new URL(window.location.href);
      from = url.searchParams.get("from");
      if(from == "import"){
          localStorage.setItem('arr_prod_i', JSON.stringify(json)); 
          goto = "import.html";
        }else if(from == "tran_in"){
          localStorage.setItem('arr_prod_t', JSON.stringify(json)); 
          goto = "transfer_in.html";
        }else if(from == "export"){
          localStorage.setItem('arr_prod_e', JSON.stringify(json)); 
          goto = "export.html";
        }else if(from == "sale"){
          localStorage.setItem('arr_prod_s', JSON.stringify(json)); 
          goto = "sale.html";
        } 
      transition_page_next(goto);    
    }

    function disactive(arg) {
      nav_menu = ['home', 'add', 'edit', 'del'];
      for (i = 0; i < 4; i++) {
        if (nav_menu[i] != arg) {
          if ($("#i-" + nav_menu[i]).hasClass('active')) $("#i-" + nav_menu[i]).removeClass('active');
        }
      }
    }

    function disac(arg){
      if ($("#i-" + arg).hasClass('active')) $("#i-" + arg).removeClass('active');
    }

    function menu(arg) {
      // Animate
      disactive(arg);
      $("#i-" + arg).fadeOut(100).fadeIn(100, function() {
        if(last_node != 1){
          $("#i-" + arg).addClass('active');
        }        
      });

      if(arg == "add"){
        if(last_node == 1){ disac("add"); return 0;}
        if($("#input-row").is(":visible")) return 0;
        text_input = "<div id='input-row' class='row'>"+
          "<div class='col-2 text-right' onclick='add();'>"+
            "<i class='fa fa-check'></i>"+
          "</div >"+
          "<div class='col-8 text-center'>"+
            "<input id='input-add' type='text' class='w3-input'>"+
          "</div>"+
            "<div class='col-2' onclick='input_clear();'>"+
              "<i class='fa fa-times'></i>"+
            "</div>"+
          "</div>";
        $("#append-ctn").append(text_input);
        //add();
      }else if(arg == "home"){
        window.location = "index.html";
      }else if(arg == "edit"){
        if(last_node == 1){ disac("edit"); return 0;}
        if ($(".i-edit").is(":visible")) {
          $(".i-trash").attr('hidden', true);
          $(".i-edit").attr('hidden', true);
          disac("edit");
        } else {
          $(".i-trash").attr('hidden', true);
          $(".i-edit").attr('hidden', false);
        }
      }else if(arg == "del"){
        if(last_node == 1){ disac("del"); return 0;}
        if($(".i-trash").is(":visible")){
          $(".i-edit").attr('hidden', true);
          $(".i-trash").attr('hidden', true);
          disac("del");
        }else{
          $(".i-edit").attr('hidden', true);
          $(".i-trash").attr('hidden', false);
        }
      }
    }

    function getIn(arg){
      url = new URL(window.location.href);
      from = url.searchParams.get("from");
      if(last_node == 0){
        goto = "select_folder.html?from="+ from+ "&folder=" +arg;
      }else if(last_node == 1){ 
        if(from == "import"){
          goto = "import.html?product="+arg;
        }else if(from == "tran_in"){
          goto = "transfer_in.html?product="+arg;
        }else if(from == "export"){
          goto = "export.html?product="+arg;
        }else if(from == "sale"){
          goto = "sale.html?product="+arg;
        }   
      }     
      transition_page_next(goto);
    }

    function add(){
      // First State
      if(!$("#main-ctn").is(":visible")){
        input = $("#first-add").val();
        if(input != ""){
          $.ajax({
            type: "POST",
            url: "https://omise-webpack.000webhostapp.com/www/php/add_folder.php",
            data: {
              'title': input,
              'parent': parent
            },
            success: function (data) {
              if (data == "success") {
                index++;
                text_html = "<div id='row-title-" + index + "' class='row'>" +
                  "<div class='col-2'></div>" +
                  "<div id='getin-" + index + "' class='col-8 text-center' onclick='getIn(\"" + input + "\")'>" +
                  "<h5 id='title-" + index + "'>" + input + "</h5>" +
                  "</div>" +
                  "<div class='col-2'>" +
                  "<i class='fa fa-trash-alt i-trash' onclick='remove(" + index + ")' hidden></i>" +
                  "<i class='fa fa-edit i-edit' onclick='edit(" + index + ")' hidden></i>" +
                  "</div>" +
                  "</div >" +
                  "<div id='row-edit-" + index + "' class='row' hidden>" +
                  "<div class='col-2 text-right' onclick='rename(" + index + ");'>" +
                  "<i class='fa fa-check'></i>" +
                  "</div >" +
                  "<div class='col-8 text-center'>" +
                  "<input id='input-" + index + "' type='text' class='w3-input' value='" + input + "'>" +
                  "</div>" +
                  "<div class='col-2' onclick='close_row_edit(" + index + ");'>" +
                  "<i class='fa fa-times'></i>" +
                  "</div>" +
                  "</div>" + "<hr id='hr-" + index + "'>";
                $("#main-ctn").prop('hidden', false);
                $("#add-ctn").prop('hidden', true);
                $("#append-ctn").append(text_html);
              } else {
                alert("เซิร์ฟเวอร์มีปัญหา กรุณาเข้าใหม่อีกครั้ง")
              }
            }
          });
        }else{
          alert("กรอกหมวดหมู่ก่อนเพิ่ม");
        }
      }else{
        input = $("#input-add").val();
        if(input != "") {
          $.ajax({
            type: "POST",
            url: "https://omise-webpack.000webhostapp.com/www/php/add_folder.php",
            data: {
              'title': input,
              'parent': parent
            },
            success: function (data) {
              if(data == "success"){
                index++;
                text_html = "<div id='row-title-" + index + "' class='row'>" +
                  "<div class='col-2'></div>" +
                  "<div id='getin-" + index + "' class='col-8 text-center' onclick='getIn(\"" + input + "\")'>" +
                  "<h5 id='title-" + index + "'>" + input + "</h5>" +
                  "</div>" +
                  "<div class='col-2'>" +
                  "<i class='fa fa-trash-alt i-trash' onclick='remove(" + index + ")' hidden></i>" +
                  "<i class='fa fa-edit i-edit' onclick='edit(" + index + ")' hidden></i>" +
                  "</div>" +
                  "</div >" +
                  "<div id='row-edit-" + index + "' class='row' hidden>" +
                  "<div class='col-2 text-right' onclick='rename(" + index + ");'>" +
                  "<i class='fa fa-check'></i>" +
                  "</div >" +
                  "<div class='col-8 text-center'>" +
                  "<input id='input-" + index + "' type='text' class='w3-input' value='" + input + "'>" +
                  "</div>" +
                  "<div class='col-2' onclick='close_row_edit(" + index + ");'>" +
                  "<i class='fa fa-times'></i>" +
                  "</div>" +
                  "</div>" + "<hr id='hr-" + index + "'>";
                $("#input-row").remove();
                $("#append-ctn").append(text_html);
              }else{
                alert("เซิร์ฟเวอร์มีปัญหา กรุณาเข้าใหม่อีกครั้ง")
              }
            }
          });
        }else{
          alert("กรอกหมวดหมู่ก่อนเพิ่ม");
        }
        disactive(add);
      }
    }

    function close_row_edit(arg){
      old_name = $("#title-" + arg).text();
      $("#input-" + arg).val(old_name);
      $("#row-title-" + arg).prop('hidden', false);
      $("#row-edit-" + arg).prop('hidden', true); 
    }

    function edit(arg){
      $("#row-title-" + arg).prop('hidden', true);
      $("#row-edit-" + arg).prop('hidden', false);
    }

    function rename(arg){
      old_name = $("#title-"+arg).text();
      name = $("#input-"+arg).val();

      // input hidden false
      // h5 hidden true
      $.ajax({
        type: "POST",
        url:"https://omise-webpack.000webhostapp.com/www/php/rename_folder.php",           
        data: {'old_name' : old_name,
               'name' : name},               
        success: function(data){                             
            $("#title-" + arg).text(name) 
            $("#getin-"+arg).attr("onclick", "getIn(\"" + name + "\")");
            $("#row-title-" + arg).prop('hidden', false);
            $("#row-edit-" + arg).prop('hidden', true);          
        }               
      });
    }

    function remove(arg){
      title = $("#title-" + arg).text();
      $("#hr-"+arg).remove();
      $("#row-title-" + arg).remove();
      $("#row-edit-" + arg).remove();

      $.ajax({
        type: "POST",
        url:"https://omise-webpack.000webhostapp.com/www/php/delete_folder.php",           
        data: {'title' : title},               
        success: function(data){                             
            //alert(data);           
        }               
      });
    }

    function input_clear(){
      $("#input-row").remove();
      disactive(add);
    }

    function select(){
      url = new URL(window.location.href);
      from = url.searchParams.get("from");
      if(from == "add"){
        goto = "add_prod.html?folder="+parent;
      }
      /*lse if(from == "sale"){
        goto = "sale.html?folder=" + parent;
      }*/
      
      transition_page_back_flip(goto);
    }

    function page_back(){
      goto = window.history.back();
      transition_page_back(goto);
    }
    //transition_page_back_flip('add_prod.html')
  </script>
</head>

<body>
  <!-- Nav menu top -->
  <div class="row fixed-top navs">
    <div class="col-1 text-center" onclick="page_back();">
      <i id="i-back" class="fas fa-angle-left"></i>
    </div>
    <div class="col-8 text-center" style="padding-left: 15%; margin-right: 4%;">
      <h5 id="h5-title"></h5>
    </div>
    <div class="col-2 text-center">
        <i id='show-box' class='fas fa-check-square' onclick='show_box()' hidden></i>
        <i id='show-box-go' class='fa fa-check' onclick='nextselect()' hidden></i>
    </div>
  </div><br>

  <!-- End big container -->
  <div id="add-ctn" class="container justify-content-center" style="margin-top: 50%;" hidden>
    <div class="container">
      <div id="row-input-add" class="row" style="margin-bottom: 10%;">
        <div class="col-12 text-center">
          <input id="first-add" type="text" class="w3-input" placeholder="เพิ่มหมวดหมู่">
        </div>
      </div>
      <div id="row-add" class="row" style="margin-bottom: 15%;">
        <div class="col-12 text-center">
          <button class="mbtn" onclick="add();">เพิ่มหมวดหมู่</button>
        </div>
      </div>
      <div id="row-select" class="row" hidden>
        <div class="col-12 text-center">
          <button class="mbtn" onclick="select();">เลือก</button>
        </div>
      </div>
    </div>
  </div>

  <div id="main-ctn" class="container justify-content-center" style="margin-top: 20%;" hidden>
    <div id="append-ctn" class="container">
    </div>
  </div> 
  <!-- End big container -->

   <!-- Nav menu bottom -->
   <div class="row fixed-bottom navs">
    <div class="col-3 text-center" onclick="menu('home')">
        <i id="i-home" class="fas fa-home menu"></i>
    </div>
    <div class="col-3 text-center" onclick="menu('add')">
        <i id="i-add" class="fas fa-plus menu"></i>
    </div>
    <div class="col-3 text-center" onclick="menu('edit')">
        <i id="i-edit" class="fas fa-edit menu"></i>
    </div>
    <div class="col-3 text-center" onclick="menu('del')">
        <i id="i-del" class="fa fa-trash-alt menu"></i>
    </div>
</div>
<!-- End Nav menu bottom -->
</body>

</html>
