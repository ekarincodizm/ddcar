<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Home</title>
    <!-- Bootstrap Import -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/jquery.easing.1.3.min.js"></script>
    <script type="text/javascript" src="js/transition.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
    <script src="cordova.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>

    <script src="js/jquery.easy-autocomplete.min.js"></script>   
    <link rel="stylesheet" href="css/easy-autocomplete.themes.min.css">

    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/popup.css">

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Prompt" rel="stylesheet">

    <style>
        #title {
            color: #666666;
            letter-spacing: 2px;
        }

        .pdlr {
            padding-left: 10%;
            padding-right: 10%;
        }
    </style>

    <script>      
        var prod_id;       
        var cost_o; 
        var flag = 0; 
        var img;    
        $(document).ready(function () { 
            url = new URL(window.location.href);
            product = url.searchParams.get("product");  

            if(localStorage.arr_prod){
                var retrievedObject = localStorage.getItem('arr_prod');
                var arr_data = JSON.parse(retrievedObject);             
                $('#check-import').text("("+arr_data.length+")");       
            }          

            if(product != null){
                $.ajax({
                    type: "POST",
                    url:"https://omise-webpack.000webhostapp.com/www/php/get_prod.php",    
                    data:{'prod_id' : product},
                    async: false,                       
                    success: function(data){
                        var obj = jQuery.parseJSON(data);                                         
                        $.each(obj, function(i, field){
                            $('#name').val(obj[i].prod_name);
                            $('#barcode').val(obj[i].prod_code); 
                            cost_o = obj[i].prod_cost;
                            prod_id = obj[i].prod_id;   
                            img = obj[i].img;   
                            if(obj[i].prod_cost == 0 && obj[i].prod_price == 0 && obj[i].prod_pricesend == 0){
                                $('#cost').val("");
                                $('#wholesale').val("");
                                $('#retail').val("");  
                            }else{
                                $('#cost').val(cost_o);
                                $('#wholesale').val(obj[i].prod_pricesend);
                                $('#retail').val(obj[i].prod_price);                     
                                flag = 1;
                            }                        
                        });                                        
                    }               
                }); 
            }

            var options = {
                url: function(phrase) {
                    return "https://omise-webpack.000webhostapp.com/www/php/searh_prod.php";
                },
                getValue: function(element) {    
                    //console.log(element);                               
                    return element.prod_name;
                },
                ajaxSettings: {                      
                method: "POST",
                data: {}
                },
                preparePostData: function(data) {
                    data.phrase = $("#name").val();                  
                    return data;
                },
                list: {                        
                    maxNumberOfElements: 5,
                    showAnimation: {
                        type: "slide",
                        time: 200
                    },
                    hideAnimation: {
                        type: "slide",
                        time: 200
                    },
                    onChooseEvent: function() {
                        var code = $("#name").getSelectedItemData().prod_code;
                        var price_w = $("#name").getSelectedItemData().prod_price;
                        var price_s = $("#name").getSelectedItemData().prod_pricesend;
                        cost_o = $("#name").getSelectedItemData().prod_cost;
                        prod_id = $("#name").getSelectedItemData().prod_id;
                        img = $("#name").getSelectedItemData().img; 

                        $('#barcode').val(code);
                        if(cost_o == 0 && price_w == 0 && price_s == 0){
                            $('#wholesale').val("");      
                            $('#retail').val("");  
                            $('#cost').val("");       
                        }else{
                            $('#wholesale').val(price_s);      
                            $('#retail').val(price_w);  
                            $('#cost').val(cost_o);                         
                            flag = 1;
                        }                                                                           
                    }
                }, 
                //theme: "blue-light",                   
                };
            $("#name").easyAutocomplete(options);      
        });

        var check =  0;
        var is_show = 0;
        function cal_avg(type){  
            if(flag == 1){
                if(type == "cost"){
                    $.ajax({
                        type: "POST",
                        url:"https://omise-webpack.000webhostapp.com/www/php/get_amt_prod.php",           
                        data: {prod:prod_id},               
                        success: function(data){                                                                    
                            var cost_n = $('#cost').val();
                            var amt_n = $('#amount').val();
                            var amt_o = data;

                            var avg = (parseInt(cost_n*amt_n) + parseInt(cost_o*amt_o))/(parseInt(amt_n)+parseInt(amt_o));    
                            
                            $('#avg-rate').text(Math.round(avg));
                            if(is_show == 0){
                               show_avg(); 
                               is_show = 1;
                            }                       
                            check = 1;                              
                        }               
                    });            
                }else if(type == "amt" && check == 1){
                    $.ajax({
                        type: "POST",
                        url:"https://omise-webpack.000webhostapp.com/www/php/get_amt_prod.php",           
                        data: {prod:prod_id},               
                        success: function(data){                                         
                            var cost_n = $('#cost').val();
                            var amt_n = $('#amount').val();
                            var amt_o = data;

                            var avg = (parseInt(cost_n*amt_n) + parseInt(cost_o*amt_o))/(parseInt(amt_n)+parseInt(amt_o));    
                            
                            $('#avg-rate').text(Math.round(avg)); 
                            if(is_show == 0){
                               show_avg(); 
                               is_show = 1;
                            }                                                         
                        }               
                    });            
                }
              
            }           
        }  

        function add_import(){           
            var code = $('#barcode').val();
            var cost = $('#cost').val();
            var price_s =$('#wholesale').val();
            var price_w =$('#retail').val(); 
            if(code != "" && cost != "" && price_s != "" && price_w != ""){      
                if(flag == 0){                 
                    $.ajax({
                        type: "POST",
                        url:"https://omise-webpack.000webhostapp.com/www/php/update_prod.php",           
                        data: {prod:prod_id , cost:cost , price_s:price_s , price_w:price_w},               
                        success: function(data){                             
                           if(data == "success"){
                                show(code,cost);
                           }else{
                               //alert("ลองอีกครั้ง");
                           }
                        }               
                    });                   
                }else if(flag == 1 && check == 1){
                    $.ajax({
                        type: "POST",
                        url:"https://omise-webpack.000webhostapp.com/www/php/update_prod.php",           
                        data: {prod:prod_id , cost:cost , price_s:price_s , price_w:price_w},
                        async : false,              
                        success: function(data){                             
                           if(data == "success"){
                                flag = 0;
                                check = 0;
                                show(code,cost);
                           }else{
                               //alert("ลองอีกครั้ง");
                           }
                        }               
                    });                   
                                       
                }else{
                    flag = 0;
                    show(code,cost);
                }               
            }else{
                $.alert({
                    title: 'คำเตือน!',
                    content: 'กรุณากรอกข้อมูลให้ครบ',
                });
            }          
        }     
        
        function show(code,cost){
            if(localStorage.arr_prod){
                var retrievedObject = localStorage.getItem('arr_prod');
                var arr_data = JSON.parse(retrievedObject);               
            }else{
                var arr_data = [];              
            }        
           
            item = {}            
            item ["qr"] =  code;
            item ["prod_id"] =  prod_id;
            item ["name"] =  $('#name').val();
            item ["cost"] =  cost;               
            item ["amt"] =  $('#amount').val();
            item ["img"] =  img;     

            arr_data.push(item); 
            localStorage.setItem('arr_prod', JSON.stringify(arr_data));         
           
            $('#check-import').text("("+arr_data.length+")");       

            $('#barcode').val("");
            $('#name').val("");
            $('#cost').val("");
            $('#wholesale').val("");
            $('#retail').val("");
            $('#amount').val("1");
            if(is_show == 1){
                show_avg(); 
                is_show = 0;
            }            
            $('#avg-rate').text("");           
        }  

        function disactive(arg) {
            nav_menu = ['home', 'bell', 'qrcode', 'bars'];
            for (i = 0; i < 4; i++) {
                if (nav_menu[i] != arg) {
                    if ($("#i-" + nav_menu[i]).hasClass('active')) $("#i-" + nav_menu[i]).removeClass('active');
                }
            }
        }

        function menu(arg) {
            // Animate
            disactive(arg);
            $("#i-" + arg).fadeOut(100).fadeIn(100, function () {
                $("#i-" + arg).addClass('active');
            });
        }       

        function selectfolder() {
            //goto = location.reload();
            goto = "select_folder.html?from=import";
            transition_page_next_flip(goto);
        }     

        function report() {     
            if(localStorage.arr_prod){      
                goto = "import_check.html";
                transition_page_next(goto);
            }            
        }

        function show_avg(){
            var popup = document.getElementById("myPopup");
            popup.classList.toggle("show");
        }

    </script>
</head>

<body style="overflow: auto;">
    <!-- Nav menu top -->
    <div class="row fixed-top navs">
        <div class="col-1 text-center" onclick="transition_page_back('index.html')">
            <i id="i-back" class="fas fa-angle-left"></i>
        </div>
        <div class="col-10 text-center">
            <h5 id="h5-title">สินค้าเข้า</h5>
        </div>
        <div class="col-1"></div>
    </div>
    <br>

    <!-- End big container -->
    <div class="container justify-content-center" style="margin-top: 15%; margin-bottom: 30%;">
        <div class="container">
            <div class="row mg-15">
                <div class="col-12 text-center" onclick="selectfolder();">
                    <button class="select_folder">เลือกสินค้า</button>
                </div>
            </div>
            <div class="row mg-10">
                <div class="col-12 text-center pdlr">
                    <label for="name">ชื่อสินค้า</label>
                    <input id="name" type="text" class="w3-input">
                </div>
            </div>
            <div class="row mg-10">
                <div class="col-6 text-center">
                    <label for="barcode">รหัส</label>
                    <input id="barcode" type="text" class="w3-input">
                </div>
                <div class="col-3 text-center">
                    <label for="amount">จำนวน</label>
                    <input id="amount" type="number" min="1" value="1" class="w3-input" onchange="cal_avg('amt')">
                </div>
                <div class="col-3 text-center">
                    <label for="cost" class="popup">ทุน
                        <span class="popuptext" id="myPopup">เฉลี่ย: <span id="avg-rate"></span></span>
                    </label>
                    <input id="cost" type="number" class="w3-input" onchange="cal_avg('cost')">
                </div>
            </div>
            <div class="row" style="margin-bottom: 18%;">
                <div class="col-6 text-center">
                    <label for="wholesale">ราคาส่ง</label>
                    <input id="wholesale" type="number" class="w3-input">
                </div>
                <div class="col-6 text-center">
                    <label for="retail">ราคาปลีก</label>
                    <input id="retail" type="number" class="w3-input">
                </div>
            </div>
            <div class="row mg-10">
                <div class="col-12 text-center">
                    <button class="mbtn" onclick="add_import();" style="width: 70%;">เพิ่มสินค้า</button>
                </div>
            </div>
            <div class="row">
                <div class="col-12 text-center">
                    <button id="btn-check" class="mbtn-green" onclick="report();">
                        ตรวจสอบ
                        <span id="check-import"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- End big container -->

    <!-- Nav menu bottom -->
    <div class="row fixed-bottom navs">
        <div class="col-3 text-center" onclick="window.location='index.html';">
            <i id="i-home" class="fas fa-home menu"></i>
        </div>
        <div class="col-3 text-center" onclick="menu('bell')">
            <i id="i-bell" class="fas fa-bell menu"></i>
        </div>
        <div class="col-3 text-center" onclick="menu('qrcode')">
            <i id="i-qrcode" class="fas fa-qrcode menu"></i>
        </div>
        <div class="col-3 text-center" onclick="menu('bars')">
            <i id="i-bars" class="fa fa-bars menu"></i>
        </div>
    </div>
    <!-- End Nav menu bottom -->
</body>

</html>